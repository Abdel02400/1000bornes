<!DOCTYPE>
<html>
<head>
    <title>1000 bornes</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" crossorigin="anonymous">
</head>
<style media="screen">
    @media (min-width: 700px) {
        .bigPlan.no-padding {
            padding-left: 2%;
            padding-right: 2%;
        }
    }
</style>
<style>
    * {
        height: 100%;
    }
    body {
        text-align: center;
        margin: 0;
        padding: 0;
        background-color: #B6EEE1;
    }
    button {
        height: 38px;
    }
    .row {
        margin: 0;
    }
    .no-padding {
        padding: 0;
    }
    .course {
        padding-left: 10%;
        padding-right: 0%;
        height: 500px;
        min-width: 500px;
        min-height: 500px;
    }
    .borderRight {
        border-right: 2px solid black;
    }
    .borderLeft {
        border-left: 2px solid black;
    }
    .borderBottom {
        border-bottom: 2px solid black;
    }
    .start {
        border-top: 2px dashed black;
        border-bottom: 2px dashed black;
    }
    .car {
        height: 15%;
        min-height: 100px;
        min-width: 500px;
        padding-left: 10%;
        padding-right: 0%;
    }
    .borderCourse {
        border-right: 2px solid black;
        border-left: 2px solid black;
    }
    .allBorder {
        border: 2px solid black;
    }
    .plan {
        height: 10%;
        border-top: 2px solid black;
    }
    .finish {
        border-bottom: 2px solid black;
    }
    .planBorderText {
        width:65px;
        margin-top:-15px;
        margin-left:auto;
        margin-right:auto;
        background-color: #B6EEE1;
        height: 30px;
    }
    .finishText {
        width:65px;
        margin-left:auto;
        margin-right:auto;
        background-color: #B6EEE1;
        height: 30px;
    }
    .paddingLeft {
        padding-left: 10%;
    }
    .players {
        padding: 2%;
    }
    .firstBlock {
        height: 45%;
    }
    #eventGame {
        height: 10%;
        border: 2px solid black;
    }
    .playerBlock {
        height: 22%;
    }
    .playerName {
        height: 12%;
    }
    .modal {
        display: block;
        position: fixed;
        z-index: 1;
        padding-top: 200px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        display: flex;
        flex-direction: column;
        height: 40%;
    }
    #modal-content-1 {
        display: block;
        height: 20%;
    }
    #modal-content-2, #modal-content-3, #cardDeck, #backgroundDeck {
        display: none;
    }
    #backgroundDeck {
        width: 60px;
        height: 80px;
    }
    #noPlayer {
        color: red;
        display: none;
    }
    #adminEvent, #noAdmin {
        display: none;
    }
    #cardDeck {
        font-size: 0.8rem;
    }
    #carPlayer-1, #carPlayer-2, #carPlayer-3, #carPlayer-4 {
        width: 50px;
        height: 70px;
        margin: auto;
        display: none;
    }
    #carPlayer-1 {
        background-color: red;
    }
    #carPlayer-2 {
        background-color: green;
    }
    #carPlayer-3 {
        background-color: blue;
    }
    #carPlayer-4 {
        background-color: yellow;
    }
    #test {
        width: 35px;
        height: 50px;
        margin-right: 1px;
    }
    #minTwo, #just1 {
        display: none;
    }
</style>
<body>

<div class="container-fluid no-padding">
    <div class="row">
        <div class="col-lg-7 col-md-12 col-sm-12 col-xs-12 no-padding bigPlan">
            <div class="row">
                <div class="col-12 car">
                    <div class="row">
                        <div class="col-9 no-padding borderLeft">
                            <div class="row">
                                <div class="col-3 no-padding borderRight">
                                    <div  id="carPlayer-1">
                                    </div>
                                </div>
                                <div class="col-3 no-padding borderRight">
                                    <div  id="carPlayer-2">
                                    </div>
                                </div>
                                <div class="col-3 no-padding borderRight">
                                    <div  id="carPlayer-3">
                                    </div>
                                </div>
                                <div class="col-3 no-padding">
                                    <div  id="carPlayer-4">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-3 no-padding">
                            <div class="row allBorder">
                                <div class="col-6 no-padding borderRight">
                                    <p id="cardDeck"><span id="nbCartesDeck"></span> cartes
                                        <img src="http://christian.deryck.free.fr/Histoire/MilleBornes/ed-1954-d1-277x390.png" alt="" id="backgroundDeck">
                                    </p>
                                </div>
                                <div class="col-6 no-padding" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 course">
                    <div class="row">
                        <div class="col-9 no-padding borderCourse">
                            <div class="row start">
                                <div class="col-3 no-padding borderRight"></div>
                                <div class="col-3 no-padding borderRight"></div>
                                <div class="col-3 no-padding borderRight"></div>
                                <div class="col-3 no-padding"></div>
                            </div>
                        </div>
                        <div class="col-3 no-padding">
                            <div class="row paddingLeft">
                                <div class="col-12 plan">
                                    <p class="planBorderText">Start</p>
                                </div>
                                <div class="col-12 plan">
                                    <p class="planBorderText">100 km</p>
                                </div>
                                <div class="col-12 plan">
                                    <p class="planBorderText">200km</p>
                                </div>
                                <div class="col-12 plan">
                                    <p class="planBorderText">300 km</p>
                                </div>
                                <div class="col-12 plan">
                                    <p class="planBorderText">400 km</p>
                                </div>
                                <div class="col-12 plan">
                                    <p class="planBorderText">500 km</p>
                                </div>
                                <div class="col-12 plan">
                                    <p class="planBorderText">600 km</p>
                                </div>
                                <div class="col-12 plan">
                                    <p class="planBorderText">700 km</p>
                                </div>
                                <div class="col-12 plan">
                                    <p class="planBorderText">800 km</p>
                                </div>
                                <div class="col-12 plan finish">
                                    <p class="planBorderText">900 km</p>
                                    <p class="finishText">Finish</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5 col-md-12 col-sm-12 col-xs-12 players">
            <div class="row">
                <div class="col-12 firstBlock no-padding">
                    <div class="row">
                        <div class="col-6 players">
                            <div class="row allBorder" id="player-1">
                                <div class="col-12 no-padding playerName borderBottom"></div>
                                <div class="col-12 row no-padding playerBlock borderBottom" id="player-1-main" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 row no-padding playerBlock borderBottom" id="player-1-bottes" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 row no-padding playerBlock borderBottom" id="player-1-alteration" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 row no-padding playerBlock" id="player-1-distance" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                            </div>
                        </div>
                        <div class="col-6 players">
                            <div class="row allBorder" id="player-2">
                                <div class="col-12 no-padding playerName borderBottom"></div>
                                <div class="col-12 row no-padding playerBlock borderBottom" id="player-2-main" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 row no-padding playerBlock borderBottom" id="player-2-bottes" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 row no-padding playerBlock borderBottom" id="player-2-alteration" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 row no-padding playerBlock" id="player-2-distance" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 firstBlock no-padding">
                    <div class="row">
                        <div class="col-6 players">
                            <div class="row allBorder" id="player-3">
                                <div class="col-12 no-padding playerName borderBottom"></div>
                                <div class="col-12 no-padding playerBlock borderBottom" id="player-3-main" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 no-padding playerBlock borderBottom" id="player-3-bottes" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 no-padding playerBlock borderBottom" id="player-3-alteration" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 no-padding playerBlock" id="player-3-distance" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                            </div>
                        </div>
                        <div class="col-6 players">
                            <div class="row allBorder" id="player-4">
                                <div class="col-12 no-padding playerName borderBottom"></div>
                                <div class="col-12 no-padding playerBlock borderBottom" id="player-4-main" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 no-padding playerBlock borderBottom" id="player-4-bottes" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 no-padding playerBlock borderBottom" id="player-4-alteration" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                                <div class="col-12 no-padding playerBlock" id="player-4-distance" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 no-padding" id="eventGame">
                    <div id="adminEvent">
                        <div id="minTwo">
                            lancer la parti
                            <button type="button" class="btn btn-primary" id="btnStartGame">Lancer la partie</button>
                        </div>
                        <div id="just1">
                            En attente d'un deuxieme joueur
                        </div>
                    </div>
                    <div id="noAdmin">
                        En attente du lancement par player 1
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="myModal" class="modal">
    <div class="modal-content">
        <div id="modal-content-1">
            <p>Bonjour, la partie n'a pas encore commencer !</p>
            <div>
                <label for="namePlayer">Entrez votre nom : </label>
                <input type="text" id="namePlayer">
            </div>
            <div style="margin-top: 15px">
                <button type="button" class="btn btn-primary" id="btnAddPlayer">Je souhaite rejoindre la partie</button>
            </div>
            <span id="noPlayer" style="margin-top: 15px">Veuillez saisir votre nom</span>
        </div>
        <div id="modal-content-2">
            <p>Bonjour, la partie est complete ! Veuillez attendre la prochaine</p>
        </div>
        <div id="modal-content-3">
            <p>Bonjour, la partie a commencer ! Veuillez attendre la prochaine</p>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script>
    var socket = io('/game',{transports: ['websocket'], upgrade: false });

    var btnAddPlayer = document.getElementById('btnAddPlayer');
    var btnStartGame = document.getElementById('btnStartGame');
    var namePlayer = document.getElementById('namePlayer');
    var noPlayer = document.getElementById('noPlayer');
    var modal = document.getElementById('myModal');
    var modalContent1 = document.getElementById('modal-content-1');
    var modalContent2 = document.getElementById('modal-content-2');
    var modalContent3 = document.getElementById('modal-content-3');

    var user = {};
    var gameComplete = false;

    var adminEvent = document.getElementById('adminEvent');
    var noAdmin = document.getElementById('noAdmin');
    var justOne = document.getElementById('just1');
    var minTwo = document.getElementById('minTwo');

    var eventGame = document.getElementById('eventGame');

    var gameStarted;

    var nbCarteDeck = document.getElementById('nbCartesDeck');
    var cardDeck = document.getElementById('cardDeck');
    var backgroundDeck = document.getElementById('backgroundDeck');

    var tour;

    var info = {};

    socket.on('tour', data => {
        if(Object.keys(user).length > 0) {
            tour = data.tour.player;
            var playerBlock = document.getElementById('player-' + tour)
            playerBlock.style.border = "3px solid yellow";
            for(var i=1; i < data.nbJoueurs + 1; i++) {
                playerBlock = document.getElementById('player-' + i)
                if(i !== parseInt(tour)) playerBlock.style.border = "2px solid black";
            }
        }
    })

    socket.on('message', data => {
        console.log(data)
    });

    socket.on('complete', data => {
        gameComplete = data;
        if(gameComplete && Object.keys(user).length === 0) {
            modalContent1.style.display = "none";
            modalContent3.style.display = "none";
            modalContent2.style.display = "block";
        } else if (!gameComplete && Object.keys(user).length === 0) {
            modalContent1.style.display = "block";
            modalContent2.style.display = "none";
            modalContent3.style.display = "none";
        }
    });

    socket.on('listPlayer', data => {
        if(Object.keys(user).length > 0) {
            for (var player in data.players) {
                if (player === user.socketid) user = data.players[player];
            }
            addPlayers(data);

            adminEvent.style.display = "none";
            noAdmin.style.display = "none";
            if(user.player === '1') {
                adminEvent.style.display = "block";
                if(Object.keys(data.players).length > 1) {
                    minTwo.style.display = "block";
                    justOne.style.display = "none";
                }else {
                    justOne.style.display = "block";
                    minTwo.style.display = "none";
                }
            }
            else {
                adminEvent.style.display = "none";
                noAdmin.style.display = "block";
            }
        }
    });

    socket.on("win", player => {
      // win message, feu d'artifice, pin up qui strip ...
    })

    socket.on("playJoueur", data => {
        console.log(data)
    })


    socket.on('myProfil', data => {
        user = data;
        modal.style.display = 'none';

    });

    socket.on('start', data => {
        gameStarted = data;
        if(gameStarted && !gameComplete && Object.keys(user).length === 0) {
            modalContent1.style.display = "none";
            modalContent2.style.display = "none";
            modalContent3.style.display = "block";
        }else if(!gameStarted && !gameComplete && Object.keys(user).length === 0) {
            modalContent1.style.display = "block";
            modalContent2.style.display = "none";
            modalContent3.style.display = "none";
            justOne.style.display = "none";
            minTwo.style.display = "none";
        }
        else if(!gameStarted && !gameComplete && Object.keys(user).length > 0) {
            modal.style.display = 'none';
            adminEvent.style.display = "none";
            noAdmin.style.display = "none";
            if(user.player === '1') {
                adminEvent.style.display = "block";
                if(Object.keys(data.players).length > 1) {
                    minTwo.style.display = "block";
                    justOne.style.display = "none";
                }else {
                    justOne.style.display = "block";
                    minTwo.style.display = "none";
                }
            }
            else {
                adminEvent.style.display = "none";
                noAdmin.style.display = "block";
            }
        }

        if(gameStarted && Object.keys(user).length >0) eventGame.style.display = "none";
        else eventGame.style.display = "block";
    })

    socket.on('deck', data => {
        if(Object.keys(user).length > 0 && gameStarted) {
            cardDeck.style.display = "block";
            backgroundDeck.style.display = "block";
            nbCarteDeck.innerHTML = data.deck.length;
            info = data;
            createBlock(data);
        }
    });

    socket.on('finishGame', data => {
        if(data) {
            user = {};
            cardDeck.style.display = "none";
            backgroundDeck.style.display = "none";
            justOne.style.display = "none";
            minTwo.style.display = "none";
            noAdmin.style.display = "none";
            modal.style.display = "block";
            resetBlock();
        }
    });

    namePlayer.addEventListener('click', () => {
        noPlayer.style.display = "none";
    });

    btnAddPlayer.addEventListener('click', (e) =>{
        e.preventDefault();
        if(namePlayer.value !== "") {
            noPlayer.style.display = "none";
            socket.emit('addPlayer', namePlayer.value);
            namePlayer.value = "";
        }else {
            noPlayer.style.display = "block";
        }
    });

    btnStartGame.addEventListener('click', (e) => {
        e.preventDefault()
        socket.emit('start', true);
    })

    var addPlayers = (data) => {
        resetBlock();
        for (var player in data.players){
            var p = document.createElement('p');
            var p2 = document.createElement('p');
            var name = document.createTextNode(data.players[player].name);
            var name2 = document.createTextNode(data.players[player].name);
            var nbPlayer = data.players[player].player
            p.appendChild(name);
            p2.appendChild(name2);

            var playerBlock = document.getElementById('player-' + nbPlayer);
            var carPlayer = document.getElementById('carPlayer-' + nbPlayer);
            playerBlock.childNodes[1].appendChild(p);
            carPlayer.appendChild(p2);
            carPlayer.style.display = "block";

        }
    }

    var resetBlock = () => {
        for(var i = 1; i<5 ; i++){
            var playerBlock = document.getElementById('player-' + i);
            var carPlayer = document.getElementById('carPlayer-' + i);
            playerBlock.childNodes[1].innerHTML = '';
            playerBlock.childNodes[3].innerHTML = '';
            playerBlock.style.border = "2px solid black";
            carPlayer.innerHTML = '';
            carPlayer.style.display = "none";
        }
    }

    var allowDrop = (e) => {
        e.preventDefault();
    }

    var drag = (e) => {
        e.dataTransfer.setData("text", e.target.id);
        e.dataTransfer.setData("src", e.target.src);
    }

    var drop = (e) => {
        e.preventDefault();
        var data = e.dataTransfer.getData("id");
        var cardSrc = e.dataTransfer.getData("src");
        var cardExact = cardSrc.split('http://localhost:8080')[1].split('/cartes/')[1].split('.png')[0];
        var realSrc = cardSrc.split('http://localhost:8080');
        var divSelected  = document.querySelector('img[class="' + user.player + '-' + realSrc[1] + '"]');
        e.target.appendChild(divSelected);
        var res = e.target.id.split('-');
        var idDestinataire = res[1];
        var destinationType = res[2];

        var allData = {
            expediteur: user.player,
            destinataire: idDestinataire,
            destinationType: destinationType,
            cardElement: cardExact,
            data: info
        };

        console.log(allData)

        socket.emit('updateGame', allData);
    }

    var createBlock = (data) => {
        for (var player in data.main){
            for(var card in data.main[player].cards){
                var playerBlock = document.getElementById('player-' + data.main[player].player);
                var imageBack = document.createElement('img');
                if(player !== user.socketid) {
                    imageBack.setAttribute('id', "test");
                    imageBack.setAttribute('src', "http://christian.deryck.free.fr/Histoire/MilleBornes/ed-1954-d1-277x390.png");
                    imageBack.setAttribute('draggable', "false");
                    imageBack.setAttribute('class', "");
                    playerBlock.childNodes[3].appendChild(imageBack);
                }else {
                    var res = data.main[player].cards[card].url.split('./images');
                    var chemin = res[1];
                    imageBack.setAttribute('id', "test");
                    imageBack.setAttribute('src', chemin);
                    if(tour === data.main[player].player) imageBack.setAttribute('draggable', "true");
                    else imageBack.setAttribute('draggable', "false");
                    imageBack.setAttribute('ondragstart', "drag(event)");
                    imageBack.setAttribute('class', data.main[player].player + '-' + chemin);
                    playerBlock.childNodes[3].appendChild(imageBack);
                }
            }
        }
    }

</script>
</body>
</html>
